name: Security Scan - OWASP ZAP (DAST)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ENTREGABLE 2 - Pipeline de Seguridad DinÃ¡mica (DAST con OWASP ZAP)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# DescripciÃ³n:
#   Pipeline de seguridad que ejecuta anÃ¡lisis dinÃ¡mico (DAST) usando OWASP ZAP
#   contra el entorno de producciÃ³n en Azure.
#
# Tipo de Escaneo:
#   - Baseline Scan: Escaneo rÃ¡pido y pasivo (sin ataques activos)
#   - Detecta vulnerabilidades comunes de OWASP Top 10
#
# ConfiguraciÃ³n:
#   - EjecuciÃ³n manual (workflow_dispatch) o programada (cron)
#   - NO rompe el pipeline (fail_action: false)
#   - Genera reporte HTML/Markdown como artifact
#   - NO crea issues en GitHub
#
# URL Objetivo: https://4.229.145.171:8080 (Azure Production)
#
# RÃºbrica: "Seguridad OWASP Real"
#
# Autor: QA Lead & Security Team
# Fecha: 24 de noviembre de 2025
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  # EjecuciÃ³n manual desde GitHub Actions UI
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL objetivo para escaneo (default: Azure Production)'
        required: false
        default: 'https://4.229.145.171:8080'
      scan_type:
        description: 'Tipo de escaneo (baseline, full-scan)'
        required: false
        default: 'baseline'
        type: choice
        options:
          - baseline
          - full-scan
  
  # EjecuciÃ³n programada: Lunes y Viernes a las 2:00 AM
  schedule:
    - cron: '0 2 * * 1,5'  # 2:00 AM UTC los lunes y viernes
  
  # Opcional: Ejecutar en push a main (comentar si no es necesario)
  # push:
  #   branches: [ "main" ]

# Permisos necesarios
permissions:
  contents: read
  security-events: write
  actions: read

env:
  # URL de producciÃ³n en Azure
  TARGET_URL: 'https://4.229.145.171:8080'
  ZAP_VERSION: 'stable'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: OWASP ZAP Baseline Scan
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  zap-baseline-scan:
    name: 'OWASP ZAP - Baseline Security Scan'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
      
      - name: ğŸ“‹ InformaciÃ³n del escaneo
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”’ INICIANDO ESCANEO DE SEGURIDAD DINÃMICA (DAST)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¯ Target URL: ${{ env.TARGET_URL }}"
          echo "ğŸ›¡ï¸  Scanner: OWASP ZAP (Zed Attack Proxy)"
          echo "ğŸ“Š Scan Type: Baseline (Passive)"
          echo "â° Fecha: $(date)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ” OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          # URL objetivo (Azure Production)
          target: ${{ github.event.inputs.target_url || env.TARGET_URL }}
          
          # Archivo de reglas de escaneo (opcional)
          # rules_file_name: '.zap/rules.tsv'
          
          # Comandos adicionales de ZAP (opcional)
          # cmd_options: '-a'
          
          # NO romper el pipeline si encuentra vulnerabilidades
          fail_action: false
          
          # NO crear issues en GitHub
          allow_issue_writing: false
          
          # Generar reporte en formato Markdown
          issue_title: 'OWASP ZAP Security Scan Report'
          
          # Token para GitHub (no necesario si allow_issue_writing = false)
          # token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“Š Procesar resultados del escaneo
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š RESULTADOS DEL ESCANEO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Verificar si existen reportes generados
          if [ -f "report_html.html" ]; then
            echo "âœ… Reporte HTML generado: report_html.html"
            ls -lh report_html.html
          else
            echo "âš ï¸  No se encontrÃ³ report_html.html"
          fi
          
          if [ -f "report_md.md" ]; then
            echo "âœ… Reporte Markdown generado: report_md.md"
            ls -lh report_md.md
            echo ""
            echo "ğŸ“‹ Contenido del reporte (primeras 50 lÃ­neas):"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            head -n 50 report_md.md || true
          else
            echo "âš ï¸  No se encontrÃ³ report_md.md"
          fi
          
          if [ -f "report_json.json" ]; then
            echo "âœ… Reporte JSON generado: report_json.json"
            ls -lh report_json.json
          else
            echo "âš ï¸  No se encontrÃ³ report_json.json"
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“¤ Upload ZAP Scan Reports (HTML)
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: zap-baseline-report-html
          path: report_html.html
          retention-days: 30
          if-no-files-found: warn
      
      - name: ğŸ“¤ Upload ZAP Scan Reports (Markdown)
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: zap-baseline-report-markdown
          path: report_md.md
          retention-days: 30
          if-no-files-found: warn
      
      - name: ğŸ“¤ Upload ZAP Scan Reports (JSON)
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: zap-baseline-report-json
          path: report_json.json
          retention-days: 30
          if-no-files-found: warn
      
      - name: ğŸ“ˆ Generar resumen en GitHub Actions
        if: always()
        run: |
          echo "# ğŸ”’ OWASP ZAP Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¯ ConfiguraciÃ³n del Escaneo" >> $GITHUB_STEP_SUMMARY
          echo "- **Target URL:** \`${{ env.TARGET_URL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Type:** Baseline (Passive)" >> $GITHUB_STEP_SUMMARY
          echo "- **Scanner:** OWASP ZAP" >> $GITHUB_STEP_SUMMARY
          echo "- **Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Resultados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Escaneo completado exitosamente" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ Reportes disponibles en Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¦ Artifacts Generados" >> $GITHUB_STEP_SUMMARY
          echo "1. **zap-baseline-report-html** - Reporte visual completo" >> $GITHUB_STEP_SUMMARY
          echo "2. **zap-baseline-report-markdown** - Reporte en texto" >> $GITHUB_STEP_SUMMARY
          echo "3. **zap-baseline-report-json** - Reporte para procesamiento automÃ¡tico" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ” PrÃ³ximos Pasos" >> $GITHUB_STEP_SUMMARY
          echo "1. Descargar y revisar el reporte HTML" >> $GITHUB_STEP_SUMMARY
          echo "2. Analizar vulnerabilidades encontradas" >> $GITHUB_STEP_SUMMARY
          echo "3. Priorizar remediation segÃºn severidad (High > Medium > Low)" >> $GITHUB_STEP_SUMMARY
          echo "4. Implementar fixes y re-escanear" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ›¡ï¸ **OWASP ZAP** - Leading Web Application Security Scanner" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: AnÃ¡lisis de Resultados y NotificaciÃ³n (Opcional)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze-results:
    name: 'Analizar Resultados de Seguridad'
    runs-on: ubuntu-latest
    needs: zap-baseline-scan
    if: always()
    
    steps:
      - name: ğŸ“¥ Download ZAP Reports
        uses: actions/download-artifact@v3
        with:
          name: zap-baseline-report-markdown
          path: ./reports
        continue-on-error: true
      
      - name: ğŸ“Š AnÃ¡lisis de Vulnerabilidades
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” ANÃLISIS DE VULNERABILIDADES DETECTADAS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ -f "./reports/report_md.md" ]; then
            echo "ğŸ“„ Reporte encontrado. Analizando..."
            
            # Contar alertas por severidad
            HIGH_COUNT=$(grep -c "High" ./reports/report_md.md || echo "0")
            MEDIUM_COUNT=$(grep -c "Medium" ./reports/report_md.md || echo "0")
            LOW_COUNT=$(grep -c "Low" ./reports/report_md.md || echo "0")
            
            echo ""
            echo "ğŸ“Š Resumen de Vulnerabilidades:"
            echo "   ğŸ”´ High:   $HIGH_COUNT"
            echo "   ğŸŸ¡ Medium: $MEDIUM_COUNT"
            echo "   ğŸŸ¢ Low:    $LOW_COUNT"
            echo ""
            
            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "âš ï¸  ATENCIÃ“N: Se encontraron $HIGH_COUNT vulnerabilidades HIGH"
              echo "   Se recomienda remediation inmediata."
            elif [ "$MEDIUM_COUNT" -gt 0 ]; then
              echo "âš ï¸  Se encontraron $MEDIUM_COUNT vulnerabilidades MEDIUM"
              echo "   Se recomienda revisar y planificar remediation."
            else
              echo "âœ… No se encontraron vulnerabilidades crÃ­ticas."
            fi
          else
            echo "âš ï¸  No se pudo encontrar el reporte para anÃ¡lisis."
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: âœ… Security Scan Completed
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ESCANEO DE SEGURIDAD COMPLETADO"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Reportes disponibles en la secciÃ³n Artifacts"
          echo "ğŸ” Revisa los reportes para detalles completos"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NOTAS IMPORTANTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. BASELINE SCAN vs FULL SCAN:
#    - Baseline: Escaneo pasivo rÃ¡pido (~5 min)
#    - Full Scan: Escaneo activo completo (~30-60 min)
#
# 2. INTERPRETACIÃ“N DE RESULTADOS:
#    - High: Vulnerabilidades crÃ­ticas, remediation inmediata
#    - Medium: Vulnerabilidades importantes, planificar fix
#    - Low: Vulnerabilidades menores, monitorear
#
# 3. OWASP TOP 10 CUBIERTO:
#    âœ… A01:2021 - Broken Access Control
#    âœ… A02:2021 - Cryptographic Failures
#    âœ… A03:2021 - Injection
#    âœ… A04:2021 - Insecure Design
#    âœ… A05:2021 - Security Misconfiguration
#    âœ… A06:2021 - Vulnerable and Outdated Components
#    âœ… A07:2021 - Identification and Authentication Failures
#    âœ… A08:2021 - Software and Data Integrity Failures
#    âœ… A09:2021 - Security Logging and Monitoring Failures
#    âœ… A10:2021 - Server-Side Request Forgery (SSRF)
#
# 4. EJECUCIÃ“N MANUAL:
#    - Ir a Actions â†’ Security Scan â†’ Run workflow
#    - Opcional: Cambiar URL objetivo
#
# 5. TROUBLESHOOTING:
#    - Si el escaneo falla por timeout en Azure:
#      * Verificar que el puerto 8080 estÃ© abierto
#      * Verificar reglas de firewall en Azure
#      * Considerar usar IP pÃºblica estable
#    - Si no hay reportes:
#      * Verificar que ZAP pueda alcanzar la URL
#      * Revisar logs del job para errores de conectividad
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
