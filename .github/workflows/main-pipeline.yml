name: Master CI/CD Pipeline

on:
  push:
    branches: [ "master", "dev" ]
  pull_request:
    branches: [ "master", "dev" ]

env:
  # Configuraci√≥n Global
  ACR_NAME: "ecommerceacrios25" # Tu nombre base sin el ambiente
  RESOURCE_GROUP_BASE: "ecommerce-rg"
  AKS_CLUSTER_BASE: "ecommerce-aks"

permissions:
  contents: read
  pull-requests: write


jobs:
  # --- ETAPA 1: INTEGRACI√ìN CONTINUA (CI) ---
  ci-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with: 
          fetch-depth: 0 
  
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      # 1. An√°lisis Est√°tico (SonarQube) - Requisito 
      # Nota: Requiere servidor Sonar. Si no tienes, usa SonarCloud.io (Gratis para p√∫blico)
      # - name: SonarQube Scan
      #   run: mvn sonar:sonar -Dsonar.projectKey=ecommerce-backend -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} -Dsonar.login=${{ secrets.SONAR_TOKEN }}
      
      # 2. Compilaci√≥n y Pruebas Unitarias - Requisito 
      - name: Build & Test
        run: mvn clean package -DskipTests # Quita skipTests cuando tu compa√±era termine las pruebas

      # 3. Escaneo de Vulnerabilidades en C√≥digo (Trivy FS) - Requisito 
      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml # Opcional
          exit-code: '0' # No fallar el pipeline, solo reportar (c√°mbialo a 1 para ser estricto)

      # 4. Versionado Sem√°ntico - Requisito 
      - name: Semantic Versioning
        id: semver
        uses: anothrNick/github-tag-action@1.67.0
        env:
          GITHUB_TOKEN: ${{ secrets.MY_PAT }}
          WITH_V: true
          DEFAULT_BUMP: patch

    outputs:
      new_version: ${{ steps.semver.outputs.new_tag }}

  # --- ETAPA 2: CONSTRUCCI√ìN Y PUBLICACI√ìN (Build & Push) ---
  build-push:
    needs: ci-check
    runs-on: ubuntu-latest
    environment: dev # Usamos secretos de dev por defecto
    steps:
      - uses: actions/checkout@v3
      
      - name: Login to ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }} # Aseg√∫rate de tener estos secretos
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push Docker Images
        run: |
          # Lista de servicios
          services="service-discovery cloud-config api-gateway product-service user-service order-service payment-service shipping-service favourite-service"
          version="${{ needs.ci-check.outputs.new_version }}"
          
          for service in $services; do
            echo "üì¶ Building $service:$version..."
            docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/$service:$version ./$service
            docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/$service:latest ./$service
            docker push ${{ secrets.ACR_LOGIN_SERVER }}/$service:$version
            docker push ${{ secrets.ACR_LOGIN_SERVER }}/$service:latest
            
            # Escaneo de Vulnerabilidades en IMAGEN (Trivy) - Requisito 
            # (Comentado para ahorrar tiempo, descomentar para demo)
            # trivy image ${{ secrets.ACR_LOGIN_SERVER }}/$service:$version
          done

  # --- ETAPA 3: DESPLIEGUE CONTINUO (CD) - DEV ---
  deploy-dev:
    needs: build-push
    runs-on: ubuntu-latest
    environment: 
      name: dev
      url: http://20.246.215.248:8080/actuator/health # Pon tu IP real aqu√≠
    steps:
      - uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} # ¬°Necesitas crear esto! (Ver abajo)

      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: "${{ env.RESOURCE_GROUP_BASE }}-dev"
          cluster-name: "${{ env.AKS_CLUSTER_BASE }}-dev"

      - name: Deploy to Kubernetes
        run: |
          # Reemplazar imagen con la versi√≥n nueva en los YAMLs
          sed -i "s|:latest|:${{ needs.ci-check.outputs.new_version }}|g" k8s/all-deployments.yaml
          # Aplicar
          kubectl apply -f k8s/all-deployments.yaml

  # --- ETAPA 4: PROMOCI√ìN A PROD (Manual) ---
  deploy-prod:
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment: 
      name: prod # ESTO ACTIVA LA APROBACI√ìN MANUAL
    if: github.ref == 'refs/heads/master' # Solo si es la rama master
    steps:
      - uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context (PROD)
        uses: azure/aks-set-context@v3
        with:
          resource-group: "${{ env.RESOURCE_GROUP_BASE }}-prod"
          cluster-name: "${{ env.AKS_CLUSTER_BASE }}-prod"

      - name: Deploy to Kubernetes (PROD)
        run: |
          # Aqu√≠ desplegar√≠amos a Prod. (Asume que el cl√∫ster Prod est√° PRENDIDO)
          sed -i "s|:latest|:${{ needs.ci-check.outputs.new_version }}|g" k8s/all-deployments.yaml
          kubectl apply -f k8s/all-deployments.yaml

  # --- ETAPA 5: NOTIFICACIONES ---
# --- ETAPA 5: NOTIFICACIONES DE FALLO ---
  notify-failure:
    needs: [ci-check, build-push, deploy-dev, deploy-prod]
    if: failure() 
    runs-on: ubuntu-latest
    steps:
      - name: Send Notification Email
        uses: dawidd6/action-send-mail@v3
        with:
          # Configuraci√≥n del Servidor (Ejemplo para Gmail)
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          
          # Credenciales (Le√≠das de Secretos)
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          
          # Detalles del Correo
          subject: "üö® ALERTA: Fall√≥ el Despliegue en ${{ github.repository }}"
          to: "isabelaocampo08@gmail.com, valengonzatapiero@gmail.com"
          from: GitHub Actions Monitor
          
          # Cuerpo del mensaje (HTML o Texto)
          body: |
            Hola equipo,
            
            El pipeline de CI/CD ha fallado. ‚ùå
            
            - Rama: ${{ github.ref }}
            - Commit: ${{ github.sha }}
            - Autor: ${{ github.actor }}
            
            Por favor revisen los logs inmediatamente:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Atentamente,
            Tu Bot de DevOps ü§ñ
