name: Master CI/CD Pipeline

on:
  push:
    branches: [ "master", "dev" ]
  pull_request:
    branches: [ "master", "dev" ]

env:
  # Configuraci√≥n Global
  ACR_NAME: "ecommerceacrios25"
  RESOURCE_GROUP_BASE: "ecommerce-rg"
  AKS_CLUSTER_BASE: "ecommerce-aks"

# --- CAMBIO 1: Permisos de escritura a nivel global ---
permissions:
  contents: write
  pull-requests: write

jobs:
  # --- ETAPA 1: INTEGRACI√ìN CONTINUA (CI) ---
  ci-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with: 
          fetch-depth: 0 
  
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      # --- AN√ÅLISIS CON SONARCLOUD ---
      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build and Analyze (SonarQube)
        env:
          GITHUB_TOKEN: ${{ secrets.MY_PAT }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        # Ejecuta 'verify' para correr tests y luego el plugin de sonar
        # Si ya pusiste las propiedades en el pom.xml, este comando las leer√° autom√°ticamente
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=isabelaocampos_Proyecto-Final-Ingeniera-de-Software-V
      # -------------------------------------------
      # 2. Compilaci√≥n y Pruebas Unitarias
      - name: Build & Test
        run: mvn clean package -DskipTests

      # 3. Escaneo de Vulnerabilidades (Trivy FS)
      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml
          exit-code: '0'

      # 4. Versionado Sem√°ntico
      - name: Semantic Versioning
        id: semver
        uses: anothrNick/github-tag-action@1.67.0
        env:
          # --- CAMBIO 2: Usamos TU token personal (PAT) en lugar del default ---
          GITHUB_TOKEN: ${{ secrets.MY_PAT }} 
          # --------------------------------------------------------------------
          WITH_V: true
          DEFAULT_BUMP: patch

      # ... (despu√©s del paso 'Semantic Versioning')

      # 5. Generar Release Notes Autom√°ticos 
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: steps.semver.outputs.new_tag != '' # Solo si hay versi√≥n nueva
        with:
          tag_name: ${{ steps.semver.outputs.new_tag }}
          name: Release ${{ steps.semver.outputs.new_tag }}
          generate_release_notes: true 
          token: ${{ secrets.MY_PAT }} # Usa tu token personal

    outputs:
      new_version: ${{ steps.semver.outputs.new_tag }}

  # --- ETAPA 2: CONSTRUCCI√ìN Y PUBLICACI√ìN (Build & Push) ---
  build-push:
    needs: ci-check
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v3
      
      - name: Login to ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push Docker Images
        run: |
          services="service-discovery cloud-config api-gateway product-service user-service order-service payment-service shipping-service favourite-service proxy-client"
          version="${{ needs.ci-check.outputs.new_version }}"
          
          for service in $services; do
            echo "üöÄ Procesando $service..."
            
            # Construir DENTRO de la carpeta para que Maven genere el target ah√≠
            cd $service
            mvn clean package -DskipTests
            
            docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/$service:$version .
            docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/$service:latest .
            
            docker push ${{ secrets.ACR_LOGIN_SERVER }}/$service:$version
            docker push ${{ secrets.ACR_LOGIN_SERVER }}/$service:latest
            
            cd ..
          done

  # --- ETAPA 3: DESPLIEGUE CONTINUO (CD) - DEV ---
  deploy-dev:
    needs: build-push
    runs-on: ubuntu-latest
    environment: 
      name: dev
      url: http://20.246.215.248:8080/actuator/health
    steps:
      - uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: "${{ env.RESOURCE_GROUP_BASE }}-dev"
          cluster-name: "${{ env.AKS_CLUSTER_BASE }}-dev"

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/all-deployments.yaml

          # Forzamos reinicio para que descargue la nueva imagen 'latest'
          kubectl rollout restart deployment

  # --- ETAPA 4: PROMOCI√ìN A PROD (Manual) ---
  deploy-prod:
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment: 
      name: prod
      # Opcional: Pon aqu√≠ la URL de tu gateway si quieres que salga en GitHub
      url: http://4.239.160.144:8080/actuator/health 
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # TRUCO: Conectamos al cl√∫ster de DEV (porque PROD no existe f√≠sicamente)
      - name: Set AKS Context (Using DEV infrastructure as PROD)
        uses: azure/aks-set-context@v3
        with:
          resource-group: "${{ env.RESOURCE_GROUP_BASE }}-dev"
          cluster-name: "${{ env.AKS_CLUSTER_BASE }}-dev"

      # LIMPIEZA: "Matamos" la versi√≥n anterior para liberar RAM y CPU
      - name: Clean Environment for Production Release
        run: |
          echo "‚ö†Ô∏è  PREPARANDO PROD: Limpiando recursos existentes..."
          kubectl delete deployment --all --ignore-not-found=true
          kubectl delete service --all --ignore-not-found=true
          
          echo "‚è≥ Esperando a que el cl√∫ster libere la memoria..."
          # Esperamos hasta que no queden pods (o m√°x 30 intentos)
          for i in {1..30}; do
            count=$(kubectl get pods --no-headers 2>/dev/null | wc -l)
            if [ "$count" -eq "0" ]; then
              echo "‚úÖ Cl√∫ster limpio. Memoria liberada."
              break
            fi
            echo "Todav√≠a hay pods terminando... ($count restantes)"
            sleep 5
          done

      # DESPLIEGUE: Instalamos la versi√≥n "Gold"
      - name: Deploy to Production
        run: |
          echo "üöÄ Desplegando versi√≥n maestra en Producci√≥n..."
          kubectl apply -f k8s/all-deployments.yaml
      
      # VERIFICACI√ìN: Nos aseguramos que todo subi√≥ bien
      - name: Verify Production Health
        run: |
          echo "üïµÔ∏è‚Äç‚ôÄÔ∏è Verificando salud de Producci√≥n..."
          deployments="zipkin service-discovery cloud-config api-gateway product-service user-service order-service payment-service shipping-service favourite-service"
          
          for deploy in $deployments; do
            # Timeout generoso de 10 mins por si Azure est√° lento
            if ! kubectl rollout status deployment/$deploy --timeout=600s; then
              echo "‚ùå ERROR: $deploy fall√≥ en arrancar en PROD."
              kubectl logs -l app=$deploy --tail=20
              exit 1 
            fi
          done
          echo "‚úÖ ¬°DESPLIEGUE A PRODUCCI√ìN EXITOSO!"

  # --- ETAPA 5: NOTIFICACIONES DE FALLO ---
  notify-failure:
    needs: [ci-check, build-push, deploy-dev, deploy-prod]
    if: failure() 
    runs-on: ubuntu-latest
    steps:
      - name: Send Notification Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üö® ALERTA: Fall√≥ el Despliegue en ${{ github.repository }}"
          to: "isabelaocampo08@gmail.com, valengonzatapiero@gmail.com"
          from: GitHub Actions Monitor
          body: |
            Hola equipo,
            El pipeline de CI/CD ha fallado. ‚ùå
            Revisar logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}